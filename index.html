<!doctype html>
<html>
  <head>
    <title>Happy Number Game</title>
  </head>
  <body>
    <div class="ui center aligned grid container raised compact segment" style="max-width: 500; margin: 0 auto">
      <div class="twelve wide column">
        <h2>Happy Number Game</h2>
        <!-- <h3>A happy number is one where...</h3>
        <h3>ABC = A! + B! + C! where A > 0, B >= 0, C >= 0</h3>
        <h3>Enter three numbers below to see if they are happy</h3> -->
        <form class="ui form">
          <div class="field">
            <div class="three fields">
              <div class="field">
                <input type="number" min="1" id="number1" />
              </div>
              <div class="field">
                <input type="number" min="0" id="number2"/>
              </div>
              <div class="field">
                <input type="number" min="0" id="number3"/>
              </div>
            </div>
          </div>
        </form>
        <div class="ui compact hidden message" id="messageBoard"></div>
        <div class="ui compact hidden message" id="triesBoard"></div>
        <button class="ui green button fluid" onClick=isThisComboHappy()>Check to see if happy</button>
        <button class="ui red button fluid" onClick=giveUp()>I give up!</button>
        <button class="ui blue button fluid" onClick=submit()>Submit Score</button>
      </div>
      <div class="two wide column">
        <h2>Leaderboard</h2>
        <button class="ui red button" onClick=logout()>Logout</button>
      </div>
      <div class="two wide column">
        <form class="ui login form">
          <h2>Login</h2>
          <div class="field">
            <label>Username</label>
            <input type="text" name="username" placeholder="youremail@email.com">
          </div>
          <div class="field">
            <label>Password</label>
            <input type="password" name="password" placeholder="password">
          </div>
          <button class="ui blue button" type="submit" onClick=login()>Login</button>
          <p onClick="showRegister()">Register</p>
        </form>
        <form class="ui register form">
          <h2>Register</h2>
          <div class="field">
            <label>Username</label>
            <input type="text" name="username" placeholder="youremail@email.com">
          </div>
          <div class="field">
            <label>Password</label>
            <input type="password" name="password" placeholder="password">
          </div>
          <button class="ui blue button" type="submit" onClick=register()>Register</button>
          <p onClick="showLogin()">Login</p>
        </form>
      </div>
    </div>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.11.8/semantic.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.11.8/semantic.min.js"></script>
    <script>
    $(document).ready(function() {
      $('.register').hide();
    })
    function factorial(num) {
      if (num === 0 || num === 1) {
        return 1;
      }
      let total = 1;
      for(let i = 1; i <= num; i++) {
        total = total * i;
      }
      return total;
    }

    let tries = 0;
    let solved = false;

    function isThisComboHappy() {
      const val1 = $("#number1").val();
      const val2 = $("#number2").val();
      const val3 = $("#number3").val();
      if(!val1 || !val2 || !val3) {
        $("#messageBoard")
          .text('Please enter a value in each field')
          .removeClass("hidden")
          .addClass("visible negative")
        return;
      }
      tries++
      $("#triesBoard")
        .removeClass("hidden")
        .addClass("visible positive")
        .text(`Tries: ${tries}`);
      const val1Factorial = factorial(val1);
      const val2Factorial = factorial(val2);
      const val3Factorial = factorial(val3);
      const concat = parseInt(`${val1}${val2}${val3}`);
      const sum = val1Factorial + val2Factorial + val3Factorial;
      if (concat === sum) {
        solved = true;
        $("#messageBoard")
          .removeClass("hidden")
          .removeClass("negative")
          .addClass("visible positive")
          .text(`You've solved it! ${val1}! + ${val2}! + ${val3}! = ${val1}${val2}${val3} `)
      } else {
        $("#messageBoard")
          .removeClass("hidden")
          .addClass("visible negative")
          .text(`NOT a happy number.  ${val1}! + ${val2}! + ${val3}! !== ${val1}${val2}${val3}`);
      }
    }
    function giveUp() {
      for (let i=1; i < 10; i++) {
        for (let j=0; j < 10; j++) {
          for (let k=0; k < 10; k++) {
            if (factorial(i) + factorial(j) + factorial(k) === parseInt(i.toString() + j.toString() + k.toString())) {
              $("#number1").val(i);
              $("#number2").val(j);
              $("#number3").val(k);
              $("#messageBoard")
                .text(`a=${i}, b=${j} and c=${k} is the only combination that is happy!`)
                .removeClass("hidden")
                .addClass("visible")
              tries = 0;
            }
          }
        }
      }
    }

    function showLogin() {
      $('.login').show();
      $('.register').hide();
    }

    function showRegister() {
      $('.register').show();
      $('.login').hide();
    }

    function hideLoginAndRegister() {
      $('.register').hide();
      $('.login').hide();
    }

    function submit() {
      const gameInfo = {
        date: new Date(),
        turns,
        solved,
      }
      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'http://localhost:3000/user', true);
      xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');

      xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
              alert(xhr.response);
          }
      }
      xhr.send(JSON.stringify(gameInfo));
    }
    function login() {
      event.preventDefault();
      $form = $('.login')
      const allFields = $form.form('get values');

      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'http://localhost:3000/login', true);
      xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');

      xhr.onreadystatechange = function () {
        console.log(xhr);
          if (xhr.status === 200) {
            localStorage.setItem('loggedIn', 'true');
            hideLoginAndRegister();
          } else {
            alert('Incorrect credentials');
          }
      }
      xhr.send(JSON.stringify(allFields));
    }
    function register() {
      event.preventDefault();
      $form = $('.register')
      const allFields = $form.form('get values');

      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'http://localhost:3000/register', true);
      xhr.setRequestHeader('Content-Type', 'application/json');

      xhr.onreadystatechange = function () {
        if (xhr.status === 200) {
          localStorage.setItem('loggedIn', 'true');
          hideLoginAndRegister();
        } else {
          alert('Registration failed.');
        }
      }
      xhr.send(JSON.stringify(allFields));
    }
    </script>
  </body>
</html>
